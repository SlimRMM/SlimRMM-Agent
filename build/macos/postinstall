#!/bin/bash
set -e

# SlimRMM Agent Post-Installation Script for macOS
# This script runs after the PKG installer copies files
#
# The installer only places files - configuration is done separately via:
#   sudo /Applications/SlimRMM.app/Contents/MacOS/slimrmm-agent install -s https://server.com -k TOKEN

APP_PATH="/Applications/SlimRMM.app"
BINARY_PATH="${APP_PATH}/Contents/MacOS/slimrmm-agent"
DATA_DIR="${APP_PATH}/Contents/Data"
CONFIG_FILE="${DATA_DIR}/.slimrmm_config.json"
LOG_DIR="/var/log/slimrmm"
LAUNCHD_PLIST="/Library/LaunchDaemons/io.slimrmm.agent.plist"

# Old paths for migration
OLD_DATA_DIR="/Library/Application Support/SlimRMM"
OLD_CONFIG_FILE="${OLD_DATA_DIR}/.slimrmm_config.json"

echo "Installing SlimRMM Agent..."

# Create data and log directories
mkdir -p "${DATA_DIR}/certs"
chmod 700 "${DATA_DIR}/certs"
mkdir -p "${LOG_DIR}"
chmod 755 "${LOG_DIR}"

# Migrate from old location if exists
if [ -f "${OLD_CONFIG_FILE}" ] && [ ! -f "${CONFIG_FILE}" ]; then
    echo "Migrating configuration from old location..."
    cp -a "${OLD_DATA_DIR}/"* "${DATA_DIR}/" 2>/dev/null || true
    echo "Migration complete"
fi

# Create symlink for CLI access
mkdir -p /usr/local/bin
ln -sf "${BINARY_PATH}" /usr/local/bin/slimrmm-agent

# Check if already configured (upgrade scenario)
if [ -f "${CONFIG_FILE}" ]; then
    echo "Existing configuration found, restarting service..."

    # Stop old service if running (don't run binary directly - just use launchctl)
    launchctl bootout system "${LAUNCHD_PLIST}" 2>/dev/null || \
        launchctl unload "${LAUNCHD_PLIST}" 2>/dev/null || true

    # Wait for service to stop
    sleep 1

    # Start service via launchctl (NOT by running the binary directly)
    # Running the binary in postinstall context would associate permissions with Terminal
    launchctl bootstrap system "${LAUNCHD_PLIST}" 2>/dev/null || \
        launchctl load -w "${LAUNCHD_PLIST}" 2>/dev/null || true

    echo "SlimRMM Agent upgraded successfully"
    exit 0
fi

# Fresh install without configuration
echo ""
echo "================================================"
echo "SlimRMM Agent installed successfully!"
echo ""
echo "To complete setup, run:"
echo "  sudo slimrmm-agent install -s https://your-server.com -k TOKEN"
echo ""
echo "Or check status:"
echo "  slimrmm-agent status"
echo "================================================"

exit 0
