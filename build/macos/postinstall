#!/bin/bash
set -e

# SlimRMM Agent Post-Installation Script for macOS
# This script runs after the PKG installer copies files
#
# The installer only places files - configuration is done separately via:
#   sudo slimrmm-agent install -s https://server.com -k TOKEN

APP_PATH="/Applications/SlimRMM.app"
BINARY_PATH="${APP_PATH}/Contents/MacOS/slimrmm-agent"
DATA_DIR="/Library/Application Support/SlimRMM"
CONFIG_FILE="${DATA_DIR}/.slimrmm_config.json"
LOG_DIR="/Library/Logs/SlimRMM"
LAUNCHD_PLIST="/Library/LaunchDaemons/io.slimrmm.agent.plist"

echo "Installing SlimRMM Agent..."

# Create data and log directories
mkdir -p "${DATA_DIR}/certs"
chmod 700 "${DATA_DIR}/certs"
mkdir -p "${LOG_DIR}"
chmod 755 "${LOG_DIR}"

# Create symlink for CLI access
ln -sf "${BINARY_PATH}" /usr/local/bin/slimrmm-agent 2>/dev/null || true

# Check if already configured (upgrade scenario)
if [ -f "${CONFIG_FILE}" ]; then
    echo "Existing configuration found, restarting service..."

    # Stop old service if running (don't run binary directly - just use launchctl)
    launchctl bootout system "${LAUNCHD_PLIST}" 2>/dev/null || \
        launchctl unload "${LAUNCHD_PLIST}" 2>/dev/null || true

    # Wait for service to stop
    sleep 1

    # Start service via launchctl (NOT by running the binary directly)
    # Running the binary in postinstall context would associate permissions with Terminal
    launchctl bootstrap system "${LAUNCHD_PLIST}" 2>/dev/null || \
        launchctl load -w "${LAUNCHD_PLIST}" 2>/dev/null || true

    echo "SlimRMM Agent upgraded successfully"
    exit 0
fi

# Check for environment variables (silent install mode)
if [ -n "$SLIMRMM_SERVER" ]; then
    echo "Server URL provided via environment: $SLIMRMM_SERVER"

    # Build install command
    INSTALL_CMD="${BINARY_PATH} install -s ${SLIMRMM_SERVER}"
    if [ -n "$SLIMRMM_TOKEN" ]; then
        INSTALL_CMD="${INSTALL_CMD} -k ${SLIMRMM_TOKEN}"
    fi

    # Run installation
    eval "${INSTALL_CMD}"

    echo "SlimRMM Agent installed successfully"
    exit 0
fi

# Fresh install without configuration
echo ""
echo "================================================"
echo "SlimRMM Agent installed successfully!"
echo ""
echo "To complete setup, run:"
echo "  sudo slimrmm-agent install -s https://your-server.com -k TOKEN"
echo ""
echo "Or check status:"
echo "  slimrmm-agent status"
echo "================================================"

exit 0
