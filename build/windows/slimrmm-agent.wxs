<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    <Product Id="*"
             Name="SlimRMM Agent"
             Language="1033"
             Version="!(bind.FileVersion.MainExecutable)"
             Manufacturer="Kiefer Networks"
             UpgradeCode="B8F5E2D1-4A3C-4B5E-9D8F-1A2B3C4D5E6F">

        <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine" />

        <MajorUpgrade DowngradeErrorMessage="A newer version of SlimRMM Agent is already installed."
                      AllowSameVersionUpgrades="yes" />

        <MediaTemplate EmbedCab="yes" />

        <Feature Id="ProductFeature" Title="SlimRMM Agent" Level="1">
            <ComponentGroupRef Id="ProductComponents" />
            <ComponentRef Id="CertsFolderComponent" />
            <ComponentRef Id="LogFolderComponent" />
            <ComponentRef Id="PathEnvComponent" />
        </Feature>

        <Property Id="SLIMRMM_SERVER" Secure="yes" />

        <!-- Service is installed via ServiceInstall element, no custom actions needed -->
    </Product>

    <Fragment>
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="ProgramFiles64Folder">
                <Directory Id="INSTALLFOLDER" Name="SlimRMM">
                    <Directory Id="CertsFolder" Name="certs" />
                    <Directory Id="LogFolder" Name="log" />
                </Directory>
            </Directory>
        </Directory>
    </Fragment>

    <Fragment>
        <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
            <Component Id="MainExecutable" Guid="A1B2C3D4-E5F6-7890-ABCD-EF1234567890" Win64="yes">
                <File Id="MainExecutable"
                      Source="slimrmm-agent.exe"
                      KeyPath="yes" />
                <ServiceInstall Id="SlimRMMService"
                               Type="ownProcess"
                               Name="SlimRMMAgent"
                               DisplayName="SlimRMM Agent"
                               Description="SlimRMM Remote Monitoring and Management Agent"
                               Start="auto"
                               Account="LocalSystem"
                               ErrorControl="normal" />
                <ServiceControl Id="StartSlimRMMService"
                               Name="SlimRMMAgent"
                               Start="install"
                               Stop="both"
                               Remove="uninstall"
                               Wait="yes" />
            </Component>
            <Component Id="HelperExecutable" Guid="F6A7B8C9-D0E1-2345-F678-901234567890" Win64="yes">
                <File Id="HelperExecutable"
                      Source="slimrmm-helper.exe"
                      KeyPath="yes" />
            </Component>
        </ComponentGroup>

        <Component Id="CertsFolderComponent" Directory="CertsFolder" Guid="C3D4E5F6-A7B8-9012-CDEF-345678901234" Win64="yes">
            <CreateFolder />
        </Component>

        <Component Id="LogFolderComponent" Directory="LogFolder" Guid="D4E5F6A7-B8C9-0123-DEF0-456789012345" Win64="yes">
            <CreateFolder />
        </Component>

        <!-- Add install directory to system PATH -->
        <Component Id="PathEnvComponent" Directory="INSTALLFOLDER" Guid="E5F6A7B8-C9D0-1234-EF01-567890123456" Win64="yes">
            <CreateFolder />
            <Environment Id="PATH"
                         Name="PATH"
                         Value="[INSTALLFOLDER]"
                         Permanent="no"
                         Part="last"
                         Action="set"
                         System="yes" />
        </Component>
    </Fragment>
</Wix>
