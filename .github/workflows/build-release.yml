name: Build and Release

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          fail_ci_if_error: false

  build:
    needs: test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          VERSION=${GITHUB_REF_NAME:-dev}
          COMMIT=${GITHUB_SHA::8}
          DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          EXT=""
          if [ "$GOOS" = "windows" ]; then
            EXT=".exe"
          fi

          go build -ldflags "-s -w \
            -X github.com/slimrmm/slimrmm-agent/pkg/version.Version=$VERSION \
            -X github.com/slimrmm/slimrmm-agent/pkg/version.GitCommit=$COMMIT \
            -X github.com/slimrmm/slimrmm-agent/pkg/version.BuildDate=$DATE" \
            -o slimrmm-agent-${{ matrix.goos }}-${{ matrix.goarch }}${EXT} \
            ./cmd/slimrmm-agent

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: slimrmm-agent-${{ matrix.goos }}-${{ matrix.goarch }}
          path: slimrmm-agent-*

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-deb:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux AMD64 artifact
        uses: actions/download-artifact@v4
        with:
          name: slimrmm-agent-linux-amd64
          path: .

      - name: Build DEB package
        run: |
          VERSION=${GITHUB_REF_NAME#v}

          mkdir -p pkg/usr/local/bin
          mkdir -p pkg/etc/systemd/system
          mkdir -p pkg/var/lib/slimrmm/{certs,log}
          mkdir -p pkg/DEBIAN

          cp slimrmm-agent-linux-amd64 pkg/usr/local/bin/slimrmm-agent
          chmod +x pkg/usr/local/bin/slimrmm-agent
          cp build/linux/slimrmm-agent.service pkg/etc/systemd/system/

          cat > pkg/DEBIAN/control << EOF
          Package: slimrmm-agent
          Version: ${VERSION}
          Section: admin
          Priority: optional
          Architecture: amd64
          Maintainer: Kiefer Networks <info@slimrmm.io>
          Description: SlimRMM Remote Monitoring & Management Agent
          EOF

          cp build/linux/postinstall.sh pkg/DEBIAN/postinst
          cp build/linux/preremove.sh pkg/DEBIAN/prerm
          chmod +x pkg/DEBIAN/postinst pkg/DEBIAN/prerm

          dpkg-deb --build pkg slimrmm-agent_${VERSION}_amd64.deb

      - name: Upload DEB to Release
        uses: softprops/action-gh-release@v1
        with:
          files: '*.deb'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-rpm:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux AMD64 artifact
        uses: actions/download-artifact@v4
        with:
          name: slimrmm-agent-linux-amd64
          path: .

      - name: Install FPM
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rubygems build-essential rpm
          sudo gem install --no-document fpm

      - name: Build RPM package
        run: |
          VERSION=${GITHUB_REF_NAME#v}

          mkdir -p pkg/usr/local/bin
          mkdir -p pkg/etc/systemd/system
          mkdir -p pkg/var/lib/slimrmm/{certs,log}

          cp slimrmm-agent-linux-amd64 pkg/usr/local/bin/slimrmm-agent
          chmod +x pkg/usr/local/bin/slimrmm-agent
          cp build/linux/slimrmm-agent.service pkg/etc/systemd/system/

          fpm -s dir -t rpm \
            -n slimrmm-agent \
            -v ${VERSION} \
            -a x86_64 \
            --description "SlimRMM Remote Monitoring & Management Agent" \
            --url "https://slimrmm.io" \
            --maintainer "Kiefer Networks <info@slimrmm.io>" \
            --license "Proprietary" \
            --after-install build/linux/postinstall.sh \
            --before-remove build/linux/preremove.sh \
            -C pkg \
            .

          mv *.rpm slimrmm-agent_${VERSION}_amd64.rpm

      - name: Upload RPM to Release
        uses: softprops/action-gh-release@v1
        with:
          files: '*.rpm'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos-pkg:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Download macOS ARM64 artifact
        uses: actions/download-artifact@v4
        with:
          name: slimrmm-agent-darwin-arm64
          path: .

      - name: Build PKG
        run: |
          VERSION=${GITHUB_REF_NAME#v}

          # Use /opt/slimrmm for everything on macOS
          mkdir -p pkg/opt/slimrmm/{bin,certs,log}
          mkdir -p pkg/Library/LaunchDaemons

          cp slimrmm-agent-darwin-arm64 pkg/opt/slimrmm/bin/slimrmm-agent
          chmod +x pkg/opt/slimrmm/bin/slimrmm-agent

          # Update plist to use new path
          sed 's|/usr/local/bin/slimrmm-agent|/opt/slimrmm/bin/slimrmm-agent|g' \
            build/macos/io.slimrmm.agent.plist > pkg/Library/LaunchDaemons/io.slimrmm.agent.plist

          # Create symlink script for postinstall
          mkdir -p scripts
          cat > scripts/postinstall << 'SCRIPT'
          #!/bin/bash
          ln -sf /opt/slimrmm/bin/slimrmm-agent /usr/local/bin/slimrmm-agent 2>/dev/null || true
          launchctl load /Library/LaunchDaemons/io.slimrmm.agent.plist 2>/dev/null || true
          exit 0
          SCRIPT
          chmod +x scripts/postinstall

          cat > scripts/preinstall << 'SCRIPT'
          #!/bin/bash
          launchctl unload /Library/LaunchDaemons/io.slimrmm.agent.plist 2>/dev/null || true
          exit 0
          SCRIPT
          chmod +x scripts/preinstall

          pkgbuild --root pkg \
            --identifier io.slimrmm.agent \
            --version ${VERSION} \
            --install-location / \
            --scripts scripts \
            slimrmm-agent_${VERSION}_darwin_arm64.pkg

      - name: Upload PKG to Release
        uses: softprops/action-gh-release@v1
        with:
          files: '*.pkg'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
