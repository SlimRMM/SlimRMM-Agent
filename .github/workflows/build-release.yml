name: Build and Release

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          fail_ci_if_error: false

  build:
    needs: test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          VERSION=${GITHUB_REF_NAME:-dev}
          COMMIT=${GITHUB_SHA::8}
          DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          EXT=""
          if [ "$GOOS" = "windows" ]; then
            EXT=".exe"
          fi

          go build -ldflags "-s -w \
            -X github.com/slimrmm/slimrmm-agent/pkg/version.Version=$VERSION \
            -X github.com/slimrmm/slimrmm-agent/pkg/version.GitCommit=$COMMIT \
            -X github.com/slimrmm/slimrmm-agent/pkg/version.BuildDate=$DATE" \
            -o slimrmm-agent-${{ matrix.goos }}-${{ matrix.goarch }}${EXT} \
            ./cmd/slimrmm-agent

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: slimrmm-agent-${{ matrix.goos }}-${{ matrix.goarch }}
          path: slimrmm-agent-*

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-deb:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux AMD64 artifact
        uses: actions/download-artifact@v4
        with:
          name: slimrmm-agent-linux-amd64
          path: .

      - name: Build DEB package
        run: |
          VERSION=${GITHUB_REF_NAME#v}

          mkdir -p pkg/usr/local/bin
          mkdir -p pkg/etc/systemd/system
          mkdir -p pkg/var/lib/slimrmm/{certs,log}
          mkdir -p pkg/DEBIAN

          cp slimrmm-agent-linux-amd64 pkg/usr/local/bin/slimrmm-agent
          chmod +x pkg/usr/local/bin/slimrmm-agent
          cp build/linux/slimrmm-agent.service pkg/etc/systemd/system/

          cat > pkg/DEBIAN/control << EOF
          Package: slimrmm-agent
          Version: ${VERSION}
          Section: admin
          Priority: optional
          Architecture: amd64
          Maintainer: Kiefer Networks <info@slimrmm.io>
          Description: SlimRMM Remote Monitoring & Management Agent
          EOF

          cp build/linux/postinstall.sh pkg/DEBIAN/postinst
          cp build/linux/preremove.sh pkg/DEBIAN/prerm
          chmod +x pkg/DEBIAN/postinst pkg/DEBIAN/prerm

          dpkg-deb --build pkg slimrmm-agent_${VERSION}_amd64.deb

      - name: Upload DEB to Release
        uses: softprops/action-gh-release@v1
        with:
          files: '*.deb'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-rpm:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux AMD64 artifact
        uses: actions/download-artifact@v4
        with:
          name: slimrmm-agent-linux-amd64
          path: .

      - name: Install FPM
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rubygems build-essential rpm
          sudo gem install --no-document fpm

      - name: Build RPM package
        run: |
          VERSION=${GITHUB_REF_NAME#v}

          mkdir -p pkg/usr/local/bin
          mkdir -p pkg/etc/systemd/system
          mkdir -p pkg/var/lib/slimrmm/{certs,log}

          cp slimrmm-agent-linux-amd64 pkg/usr/local/bin/slimrmm-agent
          chmod +x pkg/usr/local/bin/slimrmm-agent
          cp build/linux/slimrmm-agent.service pkg/etc/systemd/system/

          fpm -s dir -t rpm \
            -n slimrmm-agent \
            -v ${VERSION} \
            -a x86_64 \
            --description "SlimRMM Remote Monitoring & Management Agent" \
            --url "https://slimrmm.io" \
            --maintainer "Kiefer Networks <info@slimrmm.io>" \
            --license "Proprietary" \
            --after-install build/linux/postinstall.sh \
            --before-remove build/linux/preremove.sh \
            -C pkg \
            .

          mv *.rpm slimrmm-agent_${VERSION}_amd64.rpm

      - name: Upload RPM to Release
        uses: softprops/action-gh-release@v1
        with:
          files: '*.rpm'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos-pkg:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Download macOS ARM64 artifact
        uses: actions/download-artifact@v4
        with:
          name: slimrmm-agent-darwin-arm64
          path: .

      - name: Build PKG
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          INSTALL_DIR="/var/lib/slimrmm"
          LAUNCHD_LABEL="io.slimrmm.agent"

          # Create PKG structure - matches Python agent exactly
          mkdir -p pkg${INSTALL_DIR}
          mkdir -p pkg/Library/LaunchDaemons
          mkdir -p scripts

          # Copy binary to /var/lib/slimrmm/slimrmm-agent (like Python)
          cp slimrmm-agent-darwin-arm64 pkg${INSTALL_DIR}/slimrmm-agent
          chmod 755 pkg${INSTALL_DIR}/slimrmm-agent

          # Create LaunchDaemon plist (inline, matching Python)
          cat > pkg/Library/LaunchDaemons/${LAUNCHD_LABEL}.plist << PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>Label</key>
              <string>${LAUNCHD_LABEL}</string>
              <key>ProgramArguments</key>
              <array>
                  <string>${INSTALL_DIR}/slimrmm-agent</string>
              </array>
              <key>RunAtLoad</key>
              <true/>
              <key>KeepAlive</key>
              <dict>
                  <key>SuccessfulExit</key>
                  <false/>
              </dict>
              <key>WorkingDirectory</key>
              <string>${INSTALL_DIR}</string>
              <key>StandardOutPath</key>
              <string>${INSTALL_DIR}/log/stdout.log</string>
              <key>StandardErrorPath</key>
              <string>${INSTALL_DIR}/log/stderr.log</string>
              <key>EnvironmentVariables</key>
              <dict>
                  <key>PATH</key>
                  <string>/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin</string>
              </dict>
          </dict>
          </plist>
          PLIST

          # Preinstall script - creates directories BEFORE pkg contents are installed
          cat > scripts/preinstall << 'PREINSTALL'
          #!/bin/bash
          INSTALL_DIR="/var/lib/slimrmm"
          LAUNCHD_LABEL="io.slimrmm.agent"

          # Stop existing service
          if launchctl list | grep -q "${LAUNCHD_LABEL}"; then
              launchctl bootout system/${LAUNCHD_LABEL} 2>/dev/null || true
          fi

          # Remove old plist
          rm -f /Library/LaunchDaemons/${LAUNCHD_LABEL}.plist

          # Preserve config if exists
          if [ -f "${INSTALL_DIR}/.slimrmm_config.json" ]; then
              cp "${INSTALL_DIR}/.slimrmm_config.json" /tmp/.slimrmm_config.json.backup
          fi

          # Create fresh directories
          mkdir -p "${INSTALL_DIR}/log"
          mkdir -p "${INSTALL_DIR}/certs"

          # Restore config
          if [ -f /tmp/.slimrmm_config.json.backup ]; then
              mv /tmp/.slimrmm_config.json.backup "${INSTALL_DIR}/.slimrmm_config.json"
          fi

          exit 0
          PREINSTALL
          chmod +x scripts/preinstall

          # Postinstall script - set permissions and load service
          cat > scripts/postinstall << 'POSTINSTALL'
          #!/bin/bash
          INSTALL_DIR="/var/lib/slimrmm"
          LAUNCHD_LABEL="io.slimrmm.agent"

          # Set permissions
          chmod 755 "${INSTALL_DIR}/slimrmm-agent"
          chmod 700 "${INSTALL_DIR}/certs"
          chmod 755 "${INSTALL_DIR}/log"

          # Create symlink for convenience
          ln -sf "${INSTALL_DIR}/slimrmm-agent" /usr/local/bin/slimrmm-agent 2>/dev/null || true

          echo ""
          echo "SlimRMM Agent installed successfully"
          echo "Configure with: slimrmm-agent --install --server https://your-server.com"
          echo ""

          exit 0
          POSTINSTALL
          chmod +x scripts/postinstall

          # Build PKG
          pkgbuild --root pkg \
            --scripts scripts \
            --identifier ${LAUNCHD_LABEL} \
            --version ${VERSION} \
            --install-location / \
            slimrmm-agent_${VERSION}_darwin_arm64.pkg

      - name: Upload PKG to Release
        uses: softprops/action-gh-release@v1
        with:
          files: '*.pkg'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
