name: Build and Release

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          fail_ci_if_error: false

  build:
    needs: test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          VERSION=${GITHUB_REF_NAME:-dev}
          COMMIT=${GITHUB_SHA::8}
          DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          EXT=""
          if [ "$GOOS" = "windows" ]; then
            EXT=".exe"
          fi

          go build -ldflags "-s -w \
            -X github.com/slimrmm/slimrmm-agent/pkg/version.Version=$VERSION \
            -X github.com/slimrmm/slimrmm-agent/pkg/version.GitCommit=$COMMIT \
            -X github.com/slimrmm/slimrmm-agent/pkg/version.BuildDate=$DATE" \
            -o slimrmm-agent-${{ matrix.goos }}-${{ matrix.goarch }}${EXT} \
            ./cmd/slimrmm-agent

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: slimrmm-agent-${{ matrix.goos }}-${{ matrix.goarch }}
          path: slimrmm-agent-*

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-deb:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux AMD64 artifact
        uses: actions/download-artifact@v4
        with:
          name: slimrmm-agent-linux-amd64
          path: .

      - name: Build DEB package
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          PKGROOT="_pkgroot"

          mkdir -p ${PKGROOT}/usr/local/bin
          mkdir -p ${PKGROOT}/etc/systemd/system
          mkdir -p ${PKGROOT}/var/lib/slimrmm/{certs,log}
          mkdir -p ${PKGROOT}/DEBIAN

          cp slimrmm-agent-linux-amd64 ${PKGROOT}/usr/local/bin/slimrmm-agent
          chmod +x ${PKGROOT}/usr/local/bin/slimrmm-agent
          cp build/linux/slimrmm-agent.service ${PKGROOT}/etc/systemd/system/

          cat > ${PKGROOT}/DEBIAN/control << EOF
          Package: slimrmm-agent
          Version: ${VERSION}
          Section: admin
          Priority: optional
          Architecture: amd64
          Maintainer: Kiefer Networks <info@slimrmm.io>
          Description: SlimRMM Remote Monitoring & Management Agent
          EOF

          cp build/linux/postinstall.sh ${PKGROOT}/DEBIAN/postinst
          cp build/linux/preremove.sh ${PKGROOT}/DEBIAN/prerm
          chmod +x ${PKGROOT}/DEBIAN/postinst ${PKGROOT}/DEBIAN/prerm

          dpkg-deb --build ${PKGROOT} slimrmm-agent_${VERSION}_amd64.deb

      - name: Upload DEB to Release
        uses: softprops/action-gh-release@v1
        with:
          files: '*.deb'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-rpm:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux AMD64 artifact
        uses: actions/download-artifact@v4
        with:
          name: slimrmm-agent-linux-amd64
          path: .

      - name: Install FPM
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rubygems build-essential rpm
          sudo gem install --no-document fpm

      - name: Build RPM package
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          PKGROOT="_pkgroot"

          mkdir -p ${PKGROOT}/usr/local/bin
          mkdir -p ${PKGROOT}/etc/systemd/system
          mkdir -p ${PKGROOT}/var/lib/slimrmm/{certs,log}

          cp slimrmm-agent-linux-amd64 ${PKGROOT}/usr/local/bin/slimrmm-agent
          chmod +x ${PKGROOT}/usr/local/bin/slimrmm-agent
          cp build/linux/slimrmm-agent.service ${PKGROOT}/etc/systemd/system/

          fpm -s dir -t rpm \
            -n slimrmm-agent \
            -v ${VERSION} \
            -a x86_64 \
            --description "SlimRMM Remote Monitoring & Management Agent" \
            --url "https://slimrmm.io" \
            --maintainer "Kiefer Networks <info@slimrmm.io>" \
            --license "Proprietary" \
            --after-install build/linux/postinstall.sh \
            --before-remove build/linux/preremove.sh \
            -C ${PKGROOT} \
            .

          mv *.rpm slimrmm-agent_${VERSION}_amd64.rpm

      - name: Upload RPM to Release
        uses: softprops/action-gh-release@v1
        with:
          files: '*.rpm'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos-pkg:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Download macOS ARM64 artifact
        uses: actions/download-artifact@v4
        with:
          name: slimrmm-agent-darwin-arm64
          path: .

      - name: Build PKG
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          LAUNCHD_LABEL="io.slimrmm.agent"
          APP_SUPPORT="/Library/Application Support/SlimRMM"
          LOG_DIR="/Library/Logs/SlimRMM"
          # Use _pkgroot to avoid conflict with Go's pkg/ directory
          PKGROOT="_pkgroot"

          # Create package structure using standard macOS locations
          mkdir -p "${PKGROOT}${APP_SUPPORT}/certs"
          mkdir -p "${PKGROOT}${LOG_DIR}"
          mkdir -p "${PKGROOT}/Library/LaunchDaemons"
          mkdir -p scripts

          # Copy binary
          cp slimrmm-agent-darwin-arm64 "${PKGROOT}${APP_SUPPORT}/slimrmm-agent"
          chmod 755 "${PKGROOT}${APP_SUPPORT}/slimrmm-agent"

          # Create LaunchDaemon plist with proper macOS paths
          cat > "${PKGROOT}/Library/LaunchDaemons/${LAUNCHD_LABEL}.plist" << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>Label</key>
              <string>io.slimrmm.agent</string>
              <key>ProgramArguments</key>
              <array>
                  <string>/Library/Application Support/SlimRMM/slimrmm-agent</string>
              </array>
              <key>RunAtLoad</key>
              <true/>
              <key>KeepAlive</key>
              <dict>
                  <key>SuccessfulExit</key>
                  <false/>
              </dict>
              <key>WorkingDirectory</key>
              <string>/Library/Application Support/SlimRMM</string>
              <key>StandardOutPath</key>
              <string>/Library/Logs/SlimRMM/stdout.log</string>
              <key>StandardErrorPath</key>
              <string>/Library/Logs/SlimRMM/stderr.log</string>
              <key>EnvironmentVariables</key>
              <dict>
                  <key>PATH</key>
                  <string>/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin</string>
              </dict>
          </dict>
          </plist>
          PLIST

          # Preinstall - stop existing service
          cat > scripts/preinstall << 'PREINSTALL'
          #!/bin/bash
          launchctl bootout system/io.slimrmm.agent 2>/dev/null || true
          exit 0
          PREINSTALL
          chmod +x scripts/preinstall

          # Postinstall - set permissions and create symlink
          cat > scripts/postinstall << 'POSTINSTALL'
          #!/bin/bash
          APP_SUPPORT="/Library/Application Support/SlimRMM"
          chmod 755 "${APP_SUPPORT}/slimrmm-agent"
          chmod 700 "${APP_SUPPORT}/certs"
          # Create symlink for easy CLI access
          ln -sf "${APP_SUPPORT}/slimrmm-agent" /usr/local/bin/slimrmm-agent 2>/dev/null || true
          echo "SlimRMM Agent installed. Configure with: slimrmm-agent --install --server <URL>"
          exit 0
          POSTINSTALL
          chmod +x scripts/postinstall

          # Build PKG
          pkgbuild --root "${PKGROOT}" \
            --scripts scripts \
            --identifier ${LAUNCHD_LABEL} \
            --version ${VERSION} \
            --install-location / \
            slimrmm-agent_${VERSION}_darwin_arm64.pkg

      - name: Upload PKG to Release
        uses: softprops/action-gh-release@v1
        with:
          files: '*.pkg'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
