name: Build and Release Linux Agent

on:
  push:
    branches:
      - main
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.gitignore'

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Build for amd64 natively
  build-amd64:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Extract version
        id: version
        run: |
          VERSION=$(grep -oP "VERSION\s*=\s*['\"]?\K[0-9]+\.[0-9]+\.[0-9]+" build-linux-deb.sh || echo "1.0.0")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Build DEB package
        run: |
          chmod +x build-linux-deb.sh
          ./build-linux-deb.sh

      - name: Build RPM package
        run: |
          chmod +x build-linux-rpm.sh
          ./build-linux-rpm.sh
        continue-on-error: true

      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-amd64
          path: dist/*.deb

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-amd64
          path: dist/*.rpm
          if-no-files-found: ignore

  # Build for arm64 using QEMU emulation
  build-arm64:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build in arm64 container
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          githubToken: ${{ github.token }}
          install: |
            apt-get update
            apt-get install -y python3 python3-pip python3-venv
          run: |
            python3 -m pip install --upgrade pip
            pip3 install -r requirements.txt
            pip3 install pyinstaller
            chmod +x build-linux-deb.sh
            ./build-linux-deb.sh

      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-arm64
          path: dist/*.deb

  # Create GitHub Release
  release:
    needs: [build-amd64, build-arm64]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          VERSION=$(grep -oP "VERSION\s*=\s*['\"]?\K[0-9]+\.[0-9]+\.[0-9]+" build-linux-deb.sh || echo "1.0.0")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          TIMESTAMP=$(date +%Y%m%d%H%M)
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -name "*.deb" -exec cp {} release/ \;
          find artifacts -name "*.rpm" -exec cp {} release/ \; 2>/dev/null || true
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}-${{ steps.version.outputs.timestamp }}
          name: SlimRMM Agent v${{ steps.version.outputs.version }} (Build ${{ steps.version.outputs.short_sha }})
          body: |
            ## SlimRMM Agent v${{ steps.version.outputs.version }}

            Automated build from commit `${{ github.sha }}`

            ### Downloads

            | Platform | Architecture | File |
            |----------|--------------|------|
            | Debian/Ubuntu | amd64 (x86_64) | `slimrmm-agent_${{ steps.version.outputs.version }}_amd64.deb` |
            | Debian/Ubuntu | arm64 (aarch64) | `slimrmm-agent_${{ steps.version.outputs.version }}_arm64.deb` |

            ### Installation

            ```bash
            # Download the appropriate package for your architecture
            wget <package-url>

            # Install (Debian/Ubuntu)
            sudo apt install ./slimrmm-agent_*.deb

            # Register with server
            sudo slimrmm-agent --install --server https://your-rmm-server:8800
            ```

            ### Changes

            ```
            ${{ github.event.head_commit.message }}
            ```
          draft: false
          prerelease: false
          files: release/*
