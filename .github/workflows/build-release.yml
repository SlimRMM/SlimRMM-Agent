name: Build and Release

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          fail_ci_if_error: false

  build:
    needs: test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          VERSION=${GITHUB_REF_NAME:-dev}
          COMMIT=${GITHUB_SHA::8}
          DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          EXT=""
          if [ "$GOOS" = "windows" ]; then
            EXT=".exe"
          fi

          go build -ldflags "-s -w \
            -X github.com/kiefernetworks/slimrmm-agent/pkg/version.Version=$VERSION \
            -X github.com/kiefernetworks/slimrmm-agent/pkg/version.GitCommit=$COMMIT \
            -X github.com/kiefernetworks/slimrmm-agent/pkg/version.BuildDate=$DATE" \
            -o slimrmm-agent-${{ matrix.goos }}-${{ matrix.goarch }}${EXT} \
            ./cmd/slimrmm-agent

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: slimrmm-agent-${{ matrix.goos }}-${{ matrix.goarch }}
          path: slimrmm-agent-*

  build-macos-pkg:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: macos-14
    strategy:
      matrix:
        include:
          - goarch: arm64
            artifact: slimrmm-agent-darwin-arm64
          - goarch: amd64
            artifact: slimrmm-agent-darwin-amd64
    steps:
      - uses: actions/checkout@v4

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: .

      - name: Build PKG
        run: |
          VERSION=${GITHUB_REF_NAME#v}

          mkdir -p pkg/usr/local/bin
          mkdir -p pkg/Library/LaunchDaemons
          mkdir -p pkg/var/lib/slimrmm/{certs,log}

          cp ${{ matrix.artifact }} pkg/usr/local/bin/slimrmm-agent
          chmod +x pkg/usr/local/bin/slimrmm-agent
          cp build/macos/io.slimrmm.agent.plist pkg/Library/LaunchDaemons/

          # Create postinstall script
          mkdir -p scripts
          cat > scripts/postinstall << 'SCRIPT'
          #!/bin/bash
          mkdir -p /var/lib/slimrmm/{certs,log}
          chmod 700 /var/lib/slimrmm/certs
          launchctl load /Library/LaunchDaemons/io.slimrmm.agent.plist || true
          SCRIPT
          chmod +x scripts/postinstall

          pkgbuild --root pkg \
            --identifier io.slimrmm.agent \
            --version ${VERSION} \
            --install-location / \
            --scripts scripts \
            SlimRMM-Agent_${VERSION}_darwin_${{ matrix.goarch }}.pkg

      - name: Upload PKG
        uses: actions/upload-artifact@v4
        with:
          name: slimrmm-agent-pkg-${{ matrix.goarch }}
          path: '*.pkg'

  build-windows-msi:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: slimrmm-agent-windows-amd64
          path: .

      - name: Install WiX Toolset
        run: |
          dotnet tool install --global wix

      - name: Create WiX source
        shell: bash
        run: |
          VERSION=${GITHUB_REF_NAME#v}

          mkdir -p wix
          cat > wix/Product.wxs << 'WIXEOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
            <Package Name="SlimRMM Agent"
                     Version="$(var.Version)"
                     Manufacturer="Kiefer Networks"
                     UpgradeCode="8B5C9A47-3F4E-4D2A-9C1B-7E6D5A4F3C2B"
                     Scope="perMachine">

              <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />

              <StandardDirectory Id="ProgramFiles64Folder">
                <Directory Id="INSTALLFOLDER" Name="SlimRMM">
                  <Component Id="MainExecutable" Guid="9C6D8B47-2E5F-4A3D-8B1C-6E7D4A5F2C3B">
                    <File Id="AgentExe" Source="slimrmm-agent-windows-amd64.exe" Name="slimrmm-agent.exe" KeyPath="yes" />
                    <ServiceInstall Id="SlimRMMService"
                                    Name="SlimRMMAgent"
                                    DisplayName="SlimRMM Agent"
                                    Description="SlimRMM Remote Monitoring and Management Agent"
                                    Type="ownProcess"
                                    Start="auto"
                                    ErrorControl="normal" />
                    <ServiceControl Id="StartService" Name="SlimRMMAgent" Start="install" Stop="both" Remove="uninstall" Wait="yes" />
                  </Component>
                </Directory>
              </StandardDirectory>

              <StandardDirectory Id="CommonAppDataFolder">
                <Directory Id="SlimRMMData" Name="SlimRMM">
                  <Directory Id="CertsDir" Name="certs">
                    <Component Id="CertsFolder" Guid="AC7D9B58-3E6F-5A4E-9C2D-7F8E5B6C4D3A">
                      <CreateFolder />
                    </Component>
                  </Directory>
                  <Directory Id="LogDir" Name="log">
                    <Component Id="LogFolder" Guid="BD8E0C69-4F7A-6B5F-AD3E-8A9F6C7D5E4B">
                      <CreateFolder />
                    </Component>
                  </Directory>
                </Directory>
              </StandardDirectory>

              <Feature Id="MainFeature" Title="SlimRMM Agent" Level="1">
                <ComponentRef Id="MainExecutable" />
                <ComponentRef Id="CertsFolder" />
                <ComponentRef Id="LogFolder" />
              </Feature>
            </Package>
          </Wix>
          WIXEOF

      - name: Build MSI
        shell: bash
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          cp slimrmm-agent-windows-amd64.exe wix/
          cd wix
          wix build -d Version=${VERSION} -o ../SlimRMM-Agent_${VERSION}_windows_amd64.msi Product.wxs

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: slimrmm-agent-msi
          path: '*.msi'

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build, build-macos-pkg, build-windows-msi]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          mkdir -p dist

          # Copy binaries as tar.gz
          for os in linux darwin; do
            for arch in amd64 arm64; do
              if [ -f "artifacts/slimrmm-agent-${os}-${arch}/slimrmm-agent-${os}-${arch}" ]; then
                cd artifacts/slimrmm-agent-${os}-${arch}
                mv slimrmm-agent-${os}-${arch} slimrmm-agent
                tar -czf ../../dist/slimrmm-agent_${VERSION}_${os}_${arch}.tar.gz slimrmm-agent
                cd ../..
              fi
            done
          done

          # Windows ZIP
          if [ -f "artifacts/slimrmm-agent-windows-amd64/slimrmm-agent-windows-amd64.exe" ]; then
            cd artifacts/slimrmm-agent-windows-amd64
            mv slimrmm-agent-windows-amd64.exe slimrmm-agent.exe
            zip ../../dist/slimrmm-agent_${VERSION}_windows_amd64.zip slimrmm-agent.exe
            cd ../..
          fi

          # Copy PKG files
          cp artifacts/slimrmm-agent-pkg-*/*.pkg dist/ 2>/dev/null || true

          # Copy MSI file
          cp artifacts/slimrmm-agent-msi/*.msi dist/ 2>/dev/null || true

          # Create checksums
          cd dist
          sha256sum * > checksums.txt
          cd ..

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
