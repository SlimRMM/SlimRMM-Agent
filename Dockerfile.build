#
# SlimRMM Agent - Linux Build Container
# Copyright (c) 2025 Kiefer Networks
#
# Multi-stage Dockerfile for building DEB and RPM packages
#

FROM python:3.11-slim-bookworm AS builder

LABEL maintainer="Kiefer Networks <support@slimrmm.io>"
LABEL description="SlimRMM Agent Linux Build Environment"

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    binutils \
    dpkg-dev \
    rpm \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
COPY requirements.txt /tmp/
RUN pip install --no-cache-dir -r /tmp/requirements.txt && \
    pip install --no-cache-dir pyinstaller

# Set working directory
WORKDIR /build

# Copy source code
COPY . .

# Make build scripts executable
RUN chmod +x build-linux-deb.sh build-linux-rpm.sh

# Default command shows help
CMD ["echo", "Use: docker run ... build-deb|build-rpm|build-all [version] [arch]"]

# ============================================
# Build targets
# ============================================

FROM builder AS build-deb
ARG VERSION=1.0.0
ARG ARCH=amd64
RUN ./build-linux-deb.sh ${VERSION} ${ARCH}

FROM builder AS build-rpm
ARG VERSION=1.0.0
ARG ARCH=x86_64
RUN ./build-linux-rpm.sh ${VERSION} ${ARCH}
